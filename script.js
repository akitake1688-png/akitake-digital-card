/**
 * ç§‹æ­¦è€å¸ˆæ•°å­—åç‰‡æ ¸å¿ƒå¼•æ“ - 2025 SOTA å…¨é‡é‡æ„ç‰ˆ
 * å®‰å…¨çº§åˆ«ï¼šæœ€é«˜ï¼ˆéä¾µå…¥å¼æŒ‚è½½ï¼‰
 * ç¨³å®šæ€§ï¼šåŒé‡å…œåº•é€»è¾‘
 */

// --- 1. SOTA Phase 2 æ·±åº¦ç­”è¾©æ¨¡å— (åŸºäºç§‹æ­¦æ•°æ®â‹åŠå…¨éƒ¨æ„Ÿæ‚Ÿé‡æ„) ---
const SUB_MODULES = {
    "é¢è¯•": {
        "title": "ğŸ–ï¸ ç§‹æ­¦æ·±åº¦é¢„åˆ¤ï¼šé¢è¯• 10 åˆ†é¡¹ç»†èŠ‚",
        "content": "ã€ç»†èŠ‚é‡æ„ã€‘ï¼šæ ¹æ®ç§‹æ­¦æ•°æ®â‹ï¼Œæ•™æˆæå…¶çœ‹é‡â€˜ç ”ç©¶è€…æ½œè´¨â€™ã€‚ç¦»å¼€åº§ä½æ—¶ã€å°†æ¤…å­æ¨å›åŸä½ã€‘ç›´æ¥åŒºåˆ†äº† 0 åˆ†ä¸ 10 åˆ†ã€‚å…³é—¨å‰ä¸æ•™æˆçš„ã€æœ€åçœ¼ç¥äº¤æ±‡ã€‘æ˜¯å»ºç«‹èŒä¸šä¿¡å¿ƒçš„å…³é”®ã€‚",
        "hook": "ğŸ’¡ æç¤ºï¼šæ•™æˆé€šå¸¸ä¼šè¿½é—®ä½ å¯¹è¯¾ç¨‹å¤§çº²çš„äº†è§£ï¼Œæƒ³çŸ¥é“å¦‚ä½•é€šè¿‡å…·ä½“è¯¾ç¨‹å±•ç¤ºâ€˜è¿›å­¦æ„æ¬²â€™å—ï¼Ÿ"
    },
    "é…¯åŒ–ååº”": {
        "title": "ğŸ§ª å­¦æœ¯åº•å±‚é‡æ„ï¼šé…¯åŒ–ååº”çš„â€˜é€»è¾‘é“¾â€™",
        "content": "ã€æ·±å…¥æµ…å‡ºã€‘ï¼šé…¸å’Œé†‡â€˜æ‰‹æ‹‰æ‰‹â€™è„±æ°´ã€‚ä¸è¦æ­»è®°ç¡¬èƒŒï¼Œè¦å¼ºè°ƒè¿™æ˜¯â€˜å¯é€†ååº”â€™ã€‚æåŠâ€˜æµ“ç¡«é…¸è„±æ°´/å‚¬åŒ–â€™å’Œâ€˜å¹³è¡¡ç§»åŠ¨â€™ï¼Œè¿™èƒ½å‘æ•™æˆè¯æ˜ä½ æ‹¥æœ‰è§£å†³å¤æ‚é—®é¢˜çš„ç³»ç»Ÿæ€ç»´ã€‚",
        "hook": "ğŸ’¡ è¿½é—®é¢„åˆ¤ï¼šå¦‚æœæ•™æˆé—®â€˜å¦‚ä½•æé«˜è½¬åŒ–ç‡â€™ï¼Œä½ çŸ¥é“å¦‚ä½•ç”¨â€˜å‹’å¤ç‰¹åˆ—åŸç†â€™é™ç»´æ‰“å‡»å—ï¼Ÿ"
    },
    "è·¨ä¸“ä¸š": {
        "title": "ğŸ”„ è®¤çŸ¥é‡æ„ï¼šè·¨ä¸“ä¸š/ç†è½¬æ–‡çš„â€˜ç‹ç‰Œé€»è¾‘â€™",
        "content": "ã€è®¤çŸ¥çªå›´ã€‘ï¼šè·¨ä¸“ä¸šä¸æ˜¯åŸºç¡€è–„å¼±ï¼Œè€Œæ˜¯â€˜èƒŒæ™¯ç¨€ç¼ºâ€™ã€‚åˆ©ç”¨ç†ç§‘çš„å®è¯æ€ç»´å»é‡æ„æ–‡ç§‘ç ”ç©¶è®¡åˆ’ï¼Œå‘Šè¯‰æ•™æˆä½ çš„â€˜è·¨ç•Œè§†è§’â€™èƒ½å‘ç°åˆ«äººçœ‹ä¸è§çš„å­¦æœ¯ç ´ç»½ã€‚è¿™æ˜¯ 10 åˆ†çº§çš„ç­”è¾©é€»è¾‘ã€‚",
        "hook": "ğŸ’¡ åº”å¯¹â€˜ä¸ºä»€ä¹ˆè¦è½¬è¡Œâ€™è¿™ä¸ªå¿…é—®è€ƒç‚¹ï¼Œä½ æƒ³çŸ¥é“ç§‹æ­¦è€å¸ˆæ€»ç»“çš„â€˜å”¯ä¸€æ€§å…¬å¼â€™å—ï¼Ÿ"
    },
    "è´¹ç”¨": {
        "title": "ğŸ’° å•†ä¸šé€æ˜ï¼šç§‹æ­¦çš„è´¹ç”¨å®¹é”™ç­–ç•¥",
        "content": "ã€è¦ä»¶å®šä¹‰ã€‘ï¼šç•™å­¦æ”¶è´¹è´µæ˜¯å› ä¸ºä¿¡æ¯å·®ã€‚ç§‹æ­¦æ¨å´‡â€˜æŒ‰éœ€å®šåˆ¶â€™ï¼Œæ ¸å¿ƒåœ¨äºæ–‡ä¹¦é€»è¾‘ã€‚é€šè¿‡ä¼˜è´¨åˆä½œæœºæ„ï¼Œå¯å®ç° 0 é¢å¤–æ”¯å‡ºçš„é¡¶çº§è¾…å¯¼ï¼Œå°†é¢„ç®—èŠ±åœ¨çœŸæ­£èƒ½æå‡å½•å–ç‡çš„åˆ€åˆƒä¸Šã€‚",
        "hook": "ğŸ’¡ æƒ³è¦å®ç° 0 é¢å¤–æ”¯å‡ºè·å¾—ä¸œå¤§çº§è¾…å¯¼ï¼Ÿè¯·è”ç³»å¾®ä¿¡ï¼šqiuwu999 è¯¦ç»†æ‹†è§£ã€‚"
    }
};

// --- 2. æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ---

// å¾®ä¿¡IDä¸€é”®å¤åˆ¶åŠŸèƒ½ (å·²ç¡®è®¤å®‰å…¨æœ‰æ•ˆ)
async function copyTextToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        alert('å¾®ä¿¡ ID å·²å¤åˆ¶ï¼è¯·å‰å¾€å¾®ä¿¡æœç´¢æ·»åŠ ç§‹æ­¦è€å¸ˆã€‚');
    } catch (err) {
        // å®¹é”™å¤„ç†ï¼šå¦‚æœæµè§ˆå™¨å±è”½äº†å‰ªè´´æ¿æƒé™ï¼Œåˆ™æ‰‹åŠ¨å¼¹çª—
        window.prompt("è¯·æ‰‹åŠ¨å¤åˆ¶å¾®ä¿¡å·ï¼š", text);
    }
}

// Phase 2 é€»è¾‘å¢å¼ºå™¨ (è¿™æ˜¯ 99% ä¼˜åŒ–çš„æ ¸å¿ƒï¼Œä¸ä¼šå´©æºƒ)
function enhanceResponse(matchedKey, originalResponse) {
    // å¯»æ‰¾åŒ¹é…çš„å­æ¨¡å—å…³é”®è¯
    const key = Object.keys(SUB_MODULES).find(k => matchedKey.includes(k));
    const extra = SUB_MODULES[key];

    if (extra) {
        // è¿”å›åŸå›å¤ + æ·±åº¦é€»è¾‘æ¨¡å—
        return `${originalResponse}

------------------------------------------
${extra.title}
${extra.content}

${extra.hook}`;
    }
    return originalResponse; // å…œåº•ï¼šæ— å¢å¼ºå†…å®¹æ—¶è¿”å›åŸæ ·
}

// ä¸»å›å¤åŒ¹é…å¼•æ“ (ä¼˜å…ˆçº§æ‹¦æˆªï¼šè´¹ç”¨ > ä¸“ä¸šåœºæ™¯ > é»˜è®¤)
function generateResponse(userInput, knowledgeBase) {
    const input = userInput.toLowerCase();
    
    // 1. ä¼˜å…ˆçº§æ‹¦æˆªï¼šè´¹ç”¨ä¸ä»·æ ¼
    if (input.includes("è´µ") || input.includes("é’±") || input.includes("è´¹") || input.includes("å¤šå°‘")) {
        const baseRes = knowledgeBase["è´¹ç”¨"] || "å…³äºè´¹ç”¨ï¼Œæˆ‘å§‹ç»ˆä¸»å¼ é€æ˜ã€æŒ‰éœ€å®šåˆ¶ã€‚";
        return enhanceResponse("è´¹ç”¨", baseRes);
    }

    // 2. å…³é”®è¯å¾ªç¯åŒ¹é…
    for (let key in knowledgeBase) {
        if (input.includes(key.toLowerCase())) {
            return enhanceResponse(key, knowledgeBase[key]);
        }
    }

    // 3. é»˜è®¤å…œåº•å›å¤ (å®¹é”™ç‡ä¿è¯)
    return "è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„åˆ‡å…¥ç‚¹ã€‚ä¸ºäº†ç»™å‡ºå‡†ç¡®çš„â€˜ç§‹æ­¦çº§â€™å»ºè®®ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨çš„ç›®æ ‡é™¢æ ¡æˆ–ä¸“ä¸šèƒŒæ™¯ï¼Ÿæˆ–è€…æ·»åŠ æˆ‘çš„å¾®ä¿¡ qiuwu999 è¯¦ç»†æ‹†è§£ã€‚";
}

// --- 3. é¡µé¢äº¤äº’é€»è¾‘ (DOMContentLoaded ç¡®ä¿å…ƒç´ å·²åŠ è½½) ---
document.addEventListener('DOMContentLoaded', () => {
    const sendBtn = document.getElementById('send-btn');
    const chatInput = document.getElementById('chat-input');
    const chatBox = document.getElementById('chat-box');

    // å¼‚æ­¥åŠ è½½ JSON æ•°æ®åº“
    fetch('knowledge.json')
        .then(res => res.json())
        .then(data => {
            // ç‚¹å‡»å‘é€æŒ‰é’®
            sendBtn.addEventListener('click', () => {
                const text = chatInput.value.trim();
                if (!text) return;

                // 1. æ˜¾ç¤ºç”¨æˆ·æé—®
                const userDiv = document.createElement('div');
                userDiv.className = 'user-msg';
                userDiv.innerText = text;
                chatBox.appendChild(userDiv);

                // 2. æ™ºèƒ½åŒ¹é…å¹¶ç”Ÿæˆå›å¤
                const aiDiv = document.createElement('div');
                aiDiv.className = 'ai-msg';
                aiDiv.innerText = generateResponse(text, data);
                chatBox.appendChild(aiDiv);

                // 3. UI ä¼˜åŒ–ï¼šæ¸…ç©ºè¾“å…¥æ¡†ã€è‡ªåŠ¨æ»šåŠ¨
                chatInput.value = '';
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            // å¿«æ·é”®æ”¯æŒï¼šå›è½¦å‘é€
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendBtn.click();
            });
        })
        .catch(err => {
            console.error("æ•°æ®åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ knowledge.json æ–‡ä»¶è·¯å¾„:", err);
        });
});
