document.addEventListener('DOMContentLoaded', () => {
    // ==========================================
    // 1. UI äº¤äº’ä¸ä¿®å¤éƒ¨åˆ† (Navigation & UI Fixes)
    // ==========================================
    
    // --- å…ƒç´ è·å– ---
    const chatBody = document.getElementById('chat-body');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');

    const initialCard = document.querySelector('.initial-card');
    const menuCard = document.querySelector('.menu-card');
    const contentCards = document.querySelectorAll('.content-card');
    
    const expandButton = document.getElementById('expandButton');
    const backButton = document.getElementById('backButton');
    const menuButtons = document.querySelectorAll('.menu-button'); 
    const closeButtons = document.querySelectorAll('.close-content');

    const linkFreeMechanism = document.getElementById('linkFreeMechanism');
    const linkBilibili = document.getElementById('linkBilibili');


    // ====== å¯¼èˆªé€»è¾‘å½»åº•ä¿®å¤ (ä¿æŒä¸å˜) ======

    if (expandButton && initialCard && menuCard) {
        expandButton.addEventListener('click', () => {
            initialCard.classList.add('hidden');
            menuCard.classList.remove('hidden');
        });
    }

    if (backButton && initialCard && menuCard) {
        backButton.addEventListener('click', () => {
            contentCards.forEach(card => card.classList.add('hidden'));
            menuCard.classList.add('hidden');
            initialCard.classList.remove('hidden');
        });
    }

    if (menuButtons.length > 0 && menuCard) {
        menuButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.currentTarget.dataset.target;
                const targetCard = document.getElementById(targetId);
                
                menuCard.classList.add('hidden');
                contentCards.forEach(card => card.classList.add('hidden')); 

                if (targetCard) {
                    targetCard.classList.remove('hidden');
                }
            });
        });
    }

    if (closeButtons.length > 0 && menuCard) {
        closeButtons.forEach(button => {
            button.addEventListener('click', () => {
                const parentCard = button.closest('.content-card');
                if (parentCard) {
                    parentCard.classList.add('hidden');
                }
                menuCard.classList.remove('hidden');
            });
        });
        
    }

    if (linkFreeMechanism) {
        linkFreeMechanism.addEventListener('click', () => {
            window.open('https://www.zhihu.com/people/dong-da-ri-ben-qiu-wu-lao-shi', '_blank'); 
        });
    }

    if (linkBilibili) {
        linkBilibili.addEventListener('click', () => {
            window.open('https://space.bilibili.com/323700487/lists', '_blank');
        });
    }


    // ====== èŠå¤©åŠŸèƒ½æ ¸å¿ƒé€»è¾‘ (handleUserMessage ä¸­æ–°å¢ SNS æ¨¡å¼æ£€æŸ¥) ======

    if (sendBtn && userInput && chatBody) {
        sendBtn.addEventListener('click', handleUserMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleUserMessage();
        });
    }
    
    // --- èŠå¤©åŠŸèƒ½è¾…åŠ©å‡½æ•° ---
    function handleUserMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        if (text.startsWith("ç”Ÿæˆè¯„è®ºæˆ–å›å¤ï¼š")) {
            const prompt = text.replace("ç”Ÿæˆè¯„è®ºæˆ–å›å¤ï¼š", "").trim();
            enterSNSCommentGeneratorMode(prompt);
            userInput.value = '';
            return;
        }

        appendMessage('user', text);
        userInput.value = '';

        showTypingIndicator();
        
        setTimeout(() => {
            removeTypingIndicator();
            const response = generateAIResponse(text); 
            appendMessage('ai', response);
        }, 1500); 
    }

    function appendMessage(sender, message) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
        
        const formattedMessage = message.replace(/\n/g, '<br>');
        msgDiv.innerHTML = formattedMessage;
        
        chatBody.appendChild(msgDiv);
        chatBody.scrollTop = chatBody.scrollHeight; 
    }

    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.classList.add('message', 'ai-message');
        typingDiv.innerText = 'ç§‹æ­¦AI æ­£åœ¨æ·±åº¦åˆ†æä¸­ (ç»ˆå±€æ€ç»´)...';
        chatBody.appendChild(typingDiv);
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function removeTypingIndicator() {
        const typingDiv = document.getElementById('typing-indicator');
        if (typingDiv) typingDiv.remove();
    }


    // ==========================================
    // 2. AI æ·±åº¦ä¼˜åŒ–å±‚ (Knowledge & Intent)
    // ==========================================

    /**
     * ã€SNS_COMMENT_GENERATOR æ¨¡å¼ã€‘
     */
    function enterSNSCommentGeneratorMode(prompt) {
        showTypingIndicator();
        setTimeout(() => {
            removeTypingIndicator();
            
            let comment = `
ã€ç§‹æ­¦è€å¸ˆãƒ»çµ‚å±€æ€è€ƒã®ãƒ—ãƒ­ã‚³ãƒ¡ãƒ³ãƒˆã€‘
é’ˆå¯¹å½“å‰çƒ­è®®è¯é¢˜ï¼šã€Œ${prompt}ã€

**1. è·¨å­¦ç§‘æ´å¯Ÿ (æ–‡ç†èåˆ)ï¼š**
è¯¥é—®é¢˜ç»éå•ç»´åº¦å¯è§£ã€‚ç»“åˆç§‹æ­¦è€å¸ˆçš„ *ç†å·¥ç§‘é€»è¾‘ä¸ä¸œå¤§ç¤¾ä¼šå­¦è§†è§’*ï¼Œæˆ‘ä»¬éœ€ä»**ç³»ç»Ÿè®º**æˆ–**è¡Œä¸ºç»æµå­¦**è§’åº¦è¿›è¡Œæ·±åº¦å‰–æã€‚

**2. æ ¸å¿ƒé€»è¾‘é‡æ„ï¼š**
çœŸæ­£çš„éš¾ç‚¹åœ¨äº[ç›®æ¨™è¨­å®šã®ã‚ºãƒ¬/æƒ…å ±ã®éå¯¾ç§°æ€§]ã€‚å»ºè®®åœ¨[èµ„æºé…ç½®/ç­–ç•¥åˆ¶å®š]æ—¶ï¼Œå¿…é¡»éµå¾ª**â€œç»ˆå±€æ€ç»´â€**åæ¨ã€‚é¿å…é™·å…¥[ç›²ç›®éšå¤§æµ/çŸ­æœŸåˆ©ç›Š]çš„é™·é˜±ã€‚

**3. ä¸­è‚¯è¡ŒåŠ¨å»ºè®®ï¼š**
ç•™å­¦æ˜¯ä¸€ç¬”ä¸¥è‚ƒçš„æŠ•èµ„ã€‚è¯·åŠ¡å¿…ä¼˜å…ˆè¿›è¡Œ**ä¸€é—®ä¸€ç­”å¼çš„é¢è¯•ç­”è¾©è‰ç¨¿ç¼–è¾‘**ï¼Œç¡®ä¿æ‚¨çš„è½¯å®åŠ›æ­¦è£…åˆ°ä½ã€‚è¿™æ˜¯å°†â€˜ç ´ç»½â€™è½¬åŒ–ä¸ºä¼˜åŠ¿çš„å…³é”®ã€‚

ğŸ‘‰ *[ä¸“ä¸šä¸”ä¸­è‚¯]* ç»†èŠ‚è§„åˆ’è¯·ç›´æ¥æ·»åŠ ç§‹æ­¦è€å¸ˆå¾®ä¿¡ï¼ˆID: qiuwu999ï¼‰è¿›è¡Œä¸€å¯¹ä¸€æ·±åº¦è¯Šæ–­ã€‚
            `.trim();

            const commentDiv = document.createElement('div');
            commentDiv.classList.add('message', 'ai-message', 'sns-comment'); 
            
            commentDiv.innerHTML = comment
                .replace(/\n/g, '<br>')
                .replace(/ã€(.*?)ã€‘/g, '<strong>ã€$1ã€‘</strong>') 
                .replace(/\*(.*?)\*/g, '<em>$1</em>'); 
            
            chatBody.appendChild(commentDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            appendMessage('ai', 'âœ… **è¯„è®ºå·²ç”Ÿæˆã€‚** æ­¤ä¸ºç§‹æ­¦ç‰¹è‰²ã€ä¸“ä¸šä¸­è‚¯çš„æ–‡æ¡ˆï¼Œæ¬¢è¿ç›´æ¥å¤åˆ¶åˆ°ç¤¾äº¤åª’ä½“ä½¿ç”¨ã€‚');

        }, 1500);
    }


    /**
     * è¾“å…¥é¢„å¤„ç†å±‚ï¼šå¢å¼ºå®¹é”™ã€æœ¯è¯­å½’ä¸€åŒ–
     */
    function normalizeInput(text) {
        let normalized = text.toLowerCase();
        
        const mapping = {
            'egu': 'eju', 'æµå­¦': 'ç•™å­¦', 'ç•™è€ƒ': 'eju', 'jlpt': 'æ—¥è¯­èƒ½åŠ›è€ƒ', 
            'æ‰˜ä¸š': 'toeic', 'æ‰˜ç¦': 'toefl', 'ä¸œå¤§': 'ä¸œäº¬å¤§å­¦', 'äº¬å¤§': 'äº¬éƒ½å¤§å­¦',
            'ç§å¡¾': 'è¾…å¯¼æœºæ„', 'ä¿®å£«': 'ç ”ç©¶ç”Ÿ/ç¡•å£«', 'ä¸­ä»‹': 'æœºæ„', 'å°±èŒ': 'å°±æ´»',
            'å¤§å­¦é™¢': 'ç¡•å£«', 'ç ”ç©¶å®¤': 'å¯¼å¸ˆ', 'ç ”ç©¶ç”Ÿ': 'é¢„ç§‘ç”Ÿ', 'æ—©å¤§': 'æ—©ç¨»ç”°å¤§å­¦',
            'å¿—æœ›': 'å¿—æœ›ç†ç”±ä¹¦', 'ç ”ç©¶': 'ç ”ç©¶è®¡åˆ’ä¹¦', 'è‰ç¨¿': 'é¢è¯•è‰ç¨¿', 'é¢è¯•': 'é¢è¯•è®­ç»ƒ',
            'æ—ä¸š': 'æ–‡ç†èåˆ', 'ç”Ÿæ€': 'æ–‡ç†èåˆ', 'ç¤¾ä¼šå­¦': 'æ–‡ç†èåˆ', 'å¥åº·ä¿é™©è´¹': 'ä¿é™©', 'å¹´é‡‘': 'ä¿é™©',
            'å¥½åƒå—': 'å¥½åƒ', // æ–°å¢
        };

        for (const [key, value] of Object.entries(mapping)) {
            normalized = normalized.replace(new RegExp(key, 'g'), value);
        }
        return normalized;
    }


    // ã€æ–°å¢ã€‘éä¸¥è‚ƒ/å¹½é»˜æé—®è¯†åˆ«å™¨ - å¢å¼ºäº†â€œå¥½åƒâ€çš„åŒ¹é…
    function checkNonSeriousIntent(rawText) {
        const humorKeywords = ['å¶åƒå‘¨è¾¹', 'æç¬‘', 'æœ‰è¶£', 'å¹½é»˜', 'ç¬‘è¯', 'å¥½åƒ', 'é£è¿”', 'å‘³é“'];
        const nonSeriousPhrases = ['è·¨æ–‡åŒ–å¿ƒç†ç ”ç©¶çš„éœ€è¦', 'å…¨éƒ¨ç”¨æ¥ä¹°', 'ç§‹æ­¦è€å¸ˆå¥½åƒå—'];
        
        const text = rawText.toLowerCase();

        // åŒ¹é…åˆ°å…³é”®å¹½é»˜è¯æ±‡æˆ–éä¸¥è‚ƒçŸ­è¯­
        const isHumorous = humorKeywords.some(kw => text.includes(kw));
        const isNonSerious = nonSeriousPhrases.some(p => text.includes(p));

        return isHumorous || isNonSerious;
    }


    /**
     * çŸ¥è¯†åº“ï¼šç»“æ„åŒ–ã€ä¸“ä¸šæ·±åº¦å›å¤ (ä¿®å¤äº† LaTeX è½¬ä¹‰é—®é¢˜)
     */
    const knowledgeBase = [
        // 1. æ–‡ä¹¦åŒºåˆ† - ç ”ç©¶è®¡åˆ’ä¹¦ (æœ€é«˜ä¼˜å…ˆçº§)
        {
            keywords: ['ç ”ç©¶è®¡åˆ’ä¹¦', 'ç ”ç©¶å®¤', 'å¯¼å¸ˆ', 'ä¿®å£«', 'å¤§å­¦é™¢'],
            priority: 13,
            // **ä¿®å¤ï¼šè½¬ä¹‰ $\times$ ä¸º $\\\\times$**
            response: "ã€ç ”ç©¶è¨ˆç”»æ›¸ï¼šçµ‚å±€æ€è€ƒã®æ ¸å¿ƒæ­¦å™¨ã€‘ğŸ–‹ï¸\n\nç ”ç©¶è®¡åˆ’ä¹¦æ˜¯æ‚¨è¿›å…¥å¤§å­¦é™¢ï¼ˆç¡•å£«ï¼‰çš„**å…¥åœºåˆ¸å’Œæ ¸å¿ƒæ­¦å™¨**ï¼Œå®ƒä¾§é‡äº**ç ”ç©¶çš„ä¸¥å¯†æ€§å’Œå¯è¡Œæ€§**ï¼Œä¸å¿—æœ›ç†ç”±ä¹¦çš„æ¦‚å¿µ**å¿…é¡»ä¸¥æ ¼åŒºåˆ†**ã€‚\n\n1. **ç§‹æ­¦ç‰¹è‰²ï¼š** ç»“åˆæˆ‘**ç†å·¥ $\\\\times$ ä¸œå¤§æ–‡ç†äº¤å‰**çš„èƒŒæ™¯ï¼Œæˆ‘æ“…é•¿åœ¨æ‚¨çš„ç ”ç©¶ä¸­æ³¨å…¥**è·¨å­¦ç§‘é€»è¾‘**ã€‚æˆ‘ä»¬ä¼šåˆ©ç”¨æ‚¨çš„â€˜ç ´ç»½â€™æ¥å¼•å¯¼æ•™æˆçš„æé—®æ–¹å‘ã€‚\n2. **æˆ‘ä»¬çš„æœåŠ¡ï¼š** æˆ‘ä»¬æä¾›é«˜åº¦å®šåˆ¶åŒ–çš„**ä¸€é—®ä¸€ç­”å¼æ•™æˆç­”è¾©è‰ç¨¿ç¼–è¾‘**ï¼Œç¡®ä¿æ‚¨çš„é€»è¾‘ç»“æ„åšä¸å¯æ‘§ã€‚\n\nğŸ’¡ **ä¸‹ä¸€æ­¥ï¼š** æ‚¨çš„ç ”ç©¶ä¸»é¢˜æ˜¯ä»€ä¹ˆï¼Ÿè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘æ¥ä¸ºæ‚¨è¿›è¡Œé€»è¾‘é‡æ„ã€‚"
        },
        // 2. æ–‡ä¹¦åŒºåˆ† - å¿—æœ›ç†ç”±ä¹¦ (æœ€é«˜ä¼˜å…ˆçº§)
        {
            keywords: ['å¿—æœ›ç†ç”±ä¹¦', 'æœ¬ç§‘', 'å­¦éƒ¨', 'å¿—æ„¿'],
            priority: 13,
            response: "ã€å¿—æœ›ç†ç”±æ›¸ï¼šä¸ªæ€§ä¸æ½œåŠ›çš„ä½“ç°ã€‘âœï¸\n\nå¿—æœ›ç†ç”±ä¹¦æ˜¯æ‚¨åœ¨**å­¦éƒ¨ï¼ˆæœ¬ç§‘ï¼‰åŠå¤§å­¦é™¢**ç”³è¯·ä¸­ï¼Œå±•ç°**å­¦ä¹ åŠ¨æœºå’Œæœªæ¥ç›®æ ‡**çš„å…³é”®æ–‡ä¹¦ï¼Œå®ƒä¾§é‡äº**åŠ¨æœºã€æ½œåŠ›ã€ä»¥åŠå¯¹ä¸“ä¸šçš„å¥‘åˆåº¦**ã€‚å®ƒä¸ç ”ç©¶è®¡åˆ’ä¹¦æ˜¯ä¸åŒæ¦‚å¿µã€‚\n\n1. **æ ¸å¿ƒè¦ç‚¹ï¼š** å¿…é¡»æ¸…æ™°ã€è‚¯å®šåœ°å›ç­”ï¼šæ‚¨æ˜¯è°ï¼Ÿä¸ºä½•é€‰æ­¤ä¸“ä¸šï¼Ÿæ¥äº†èƒ½åšä»€ä¹ˆï¼Ÿä¸èƒ½æœ‰ä»»ä½•æš§æ˜§æŠ½è±¡çš„è¡¨è¾¾ã€‚\n2. **æˆ‘ä»¬çš„è§’è‰²ï¼š** æˆ‘ä»¬å¸®åŠ©æ‚¨å°†é›¶æ•£ç»å†ä¸²è”æˆæ‰£äººå¿ƒå¼¦çš„**â€œå­¦æœ¯æˆé•¿å²â€**ï¼Œå¹¶æä¾›ä¸“ä¸šçš„æ–‡ä¹¦è‰ç¨¿ç¼–è¾‘æœåŠ¡ã€‚\n\nğŸ’¡ **è¯·é—®ï¼š** æ‚¨æ˜¯ç”³è¯·æœ¬ç§‘è¿˜æ˜¯ç¡•å£«ï¼Ÿæ‚¨ç›®å‰æœ‰å“ªäº›ç»å†æˆ–ç‰¹é•¿æƒ³è¦å¼ºè°ƒï¼Ÿ"
        },
        // 3. æ ¸å¿ƒæœåŠ¡ - é¢è¯•è®­ç»ƒä¸ç­”è¾©
        {
            keywords: ['é¢è¯•è®­ç»ƒ', 'ç­”è¾©è‰ç¨¿', 'å£è¯­', 'éè¯­è¨€', 'ç´§å¼ '],
            priority: 12,
            response: "ã€é¢æ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼šéè¯­è¨€æ²Ÿé€šçš„æ”¯é…ã€‘ğŸ—£ï¸\n\né¢è¯•æ˜¯è€ƒå¯Ÿè½¯å®åŠ›çš„æœ€é«˜é˜¶æ®µã€‚æˆ‘ä»¬ç‹¬åˆ›çš„è¾…å¯¼æ ¸å¿ƒåœ¨äº**éè¯­è¨€æ²Ÿé€šæŠ€å·§å’Œç­–ç•¥**ã€‚\n\n1. **æœåŠ¡ç‰¹è‰²ï¼š** æä¾›**ä¸€é—®ä¸€ç­”å¼æ•™æˆç­”è¾©è‰ç¨¿ç¼–è¾‘**ï¼Œä¸ºæ‚¨è®¾è®¡å·§å¦™çš„å›ç­”ï¼Œæå‰åŸ‹è®¾â€˜ç ´ç»½â€™å¼•å¯¼æ•™æˆæé—®ã€‚\n2. **å…¨çœŸæ¨¡æ‹Ÿï¼š** è¿›è¡Œ**â€˜åå§¿/çœ¼ç¥/é€’äº¤ææ–™â€™**å…¨çœŸæ¨¡æ‹Ÿï¼Œç¡®ä¿æ‚¨çš„æ¯ä¸€ä¸ªç»†èŠ‚éƒ½ç¬¦åˆæ—¥æœ¬é¡¶å°–å­¦åºœçš„æ ‡å‡†ã€‚å¯¹ä¸ªåˆ«éœ€æ±‚ï¼Œæˆ‘ä»¬è¿˜æä¾›**æ—¥è¯­å£è¯­è®­ç»ƒè¾…å¯¼**ã€‚\n\nğŸ’¡ **è¯·é—®ï¼š** æ‚¨æœ€è¿‘ä¸€æ¬¡é¢è¯•æˆ–å£è¯­è®­ç»ƒæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿæ‚¨æœ€æ‹…å¿ƒè‡ªå·±å“ªä¸ªç¯èŠ‚è¡¨ç°ä¸å¥½ï¼Ÿ"
        },
        // 4. èƒŒæ™¯ä¸ä¼˜åŠ¿
        {
            keywords: ['ç§‹æ­¦', 'è€å¸ˆ', 'èƒŒæ™¯', 'ä¼˜åŠ¿', 'æ–‡ç†èåˆ'],
            priority: 11,
            // **ä¿®å¤ï¼šè½¬ä¹‰ $\times$ ä¸º $\\\\times$**
            response: "ã€ç§‹æ­¦è€å¸ˆï¼šæ–‡ç†èåˆçš„è·¨å­¦ç§‘ä¸“å®¶ã€‘ğŸ“\n\nç§‹æ­¦è€å¸ˆçš„èƒŒæ™¯ç‹¬å…·ä¼˜åŠ¿ï¼š**ç†å·¥ç§‘æœ¬ç§‘ $\\\\times$ ä¸œå¤§æ–‡ç†äº¤å‰ç¡•å£«**ï¼ˆæ—ä¸šç”Ÿæ€ä¸‹çš„ç¤¾ä¼šå­¦ç ”ç©¶ï¼‰ã€‚\n\n1. **æ ¸å¿ƒä¼˜åŠ¿ï¼š** è¿™æ®µç»å†è®©è€å¸ˆå…·å¤‡**è·¨å­¦ç§‘æ€ç»´**ï¼Œèƒ½ä»**æ•°æ®/é€»è¾‘**ï¼ˆç†ç§‘ï¼‰å’Œ**ç¤¾ä¼š/æ–‡åŒ–**ï¼ˆæ–‡ç§‘ï¼‰åŒé‡è§’åº¦åˆ†æé—®é¢˜ã€‚è¿™æ­£æ˜¯æ—¥æœ¬é¡¶å°–å¤§å­¦æœ€çœ‹é‡çš„èƒ½åŠ›ã€‚\n2. **è¾…å¯¼ç‰¹ç‚¹ï¼š** ä¸ä»…æ˜¯æ”¹æ–‡ä¹¦ï¼Œè€Œæ˜¯æä¾›â€˜ä¸œå¤§åŸºå‡†â€™çš„**é€»è¾‘é‡æ„**ï¼Œå¹¶æ“…é•¿å°†å­¦ç”Ÿçš„èƒŒæ™¯â€˜ç ´ç»½â€™è½¬åŒ–ä¸ºç‹¬ç‰¹ä¼˜åŠ¿ã€‚\n\nğŸ’¡ **ä¸‹ä¸€æ­¥ï¼š** æ‚¨çš„èƒŒæ™¯æ˜¯æ–‡ç§‘è¿˜æ˜¯ç†ç§‘ï¼Ÿæˆ‘å¯ä»¥å¸®æ‚¨åˆ†æå¦‚ä½•å°†æ‚¨çš„ç»å†è½¬åŒ–ä¸ºç‹¬ç‰¹ä¼˜åŠ¿ã€‚"
        },
        // 5. è´¹ç”¨ä¸æ¨¡å¼
        {
            keywords: ['è´¹ç”¨', 'é’±', 'é¢„ç®—', 'å…è´¹', 'æ”¶è´¹'],
            priority: 10,
            response: "ã€æ”¶è´¹æ¨¡å¼ä¸å…è´¹æœºåˆ¶ã€‘ğŸ¤ é€æ˜åº¦æ˜¯åˆä½œçš„åŸºçŸ³ã€‚\n\n1. **å¼ºæ¨å…è´¹æ¨¡å¼ï¼š** é€šè¿‡ç§‹æ­¦è€å¸ˆçš„æ¨èè¿›å…¥åˆä½œæœºæ„ï¼Œæœºæ„æ”¯ä»˜çš„ä»‹ç»è´¹ç­‰åŒäºæ›¿æ‚¨æ”¯ä»˜äº†ç§‹æ­¦è€å¸ˆçš„**ä¸€å¯¹ä¸€è¾…å¯¼è´¹**ã€‚æ‚¨äº«å—é«˜ç«¯å®šåˆ¶æœåŠ¡ï¼Œæ— é¢å¤–æ”¯å‡ºã€‚\n2. **å®šåˆ¶æ”¶è´¹ï¼š** é’ˆå¯¹é«˜åº¦å®šåˆ¶åŒ–çš„æ–‡ä¹¦æ‰“ç£¨ã€é¢è¯•ç­”è¾©è‰ç¨¿ç¼–è¾‘ç­‰æœåŠ¡ï¼Œæˆ‘ä»¬æä¾›ä¸åŒçš„è´¹ç”¨å•ä»·ä¸å¥—é¤è¾…å¯¼ã€‚\n\nğŸ’¡ **è¯¦ç»†æ²Ÿé€šï¼š** è¯·åŠ å¾®ä¿¡ï¼ˆqiuwu999ï¼‰è¿›è¡Œä¸€å¯¹ä¸€å’¨è¯¢ï¼Œæˆ‘ä»¬å°†æ ¹æ®æ‚¨çš„éœ€æ±‚æä¾›æœ€ä¸­è‚¯çš„è´¹ç”¨è¯„ä¼°ã€‚"
        },
        // 6. EJUä¸è€ƒå­¦åº•å±‚é€»è¾‘ (å¼ºåŒ–äº†â€œè¯•é”™â€æ¦‚å¿µ)
        {
            keywords: ['eju', 'åˆ†æ•°', 'ç•™è€ƒ', 'éš¾', 'åº•å±‚é€»è¾‘'],
            priority: 9,
            response: "ã€EJUä¸è€ƒå­¦åº•å±‚é€»è¾‘ã€‘ğŸ“š EJUåªæ˜¯æ•²é—¨ç –ï¼Œ**è½¯å®åŠ›**æ‰æ˜¯æ ¸å¿ƒã€‚\n\nç§‹æ­¦è€å¸ˆå¸¸è¯´ï¼šåˆæ ¼çš„åº•å±‚é€»è¾‘æ˜¯**ä¸è¦æ”¾å¼ƒä»»ä½•è¯•é”™æœºä¼š**ã€‚å¾ˆå¤šå¤§å­¦ç”³æŠ¥æ—¶åªéœ€â€˜å—é¨“ç¥¨â€™ï¼Œæ”¾å¼ƒ6æœˆç•™è€ƒä¼šå¤±å»ä¸´åœºä½“éªŒæ ¡å†…è€ƒçš„æœºä¼šã€‚\n\n1. **ç­–ç•¥ï¼š** æˆ‘ä»¬å°†æ‚¨çš„EJUæˆç»©è§†ä¸º**â€˜å­¦æœ¯å¼ºé¡¹â€™**çš„è¯æ˜ã€‚å³ä½¿æˆç»©æœ‰â€˜ç ´ç»½â€™ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå°†å…¶è½¬åŒ–ä¸ºç‹¬ç‰¹è§†è§’ï¼Œå¼•å¯¼æ•™æˆæé—®ã€‚\n2. **è½¯å®åŠ›ï¼š** äººä¸äººä¹‹é—´çš„è®¤çŸ¥åå·®ä¸»è¦ä½“ç°åœ¨**é¢è¯•æ²Ÿé€š**ç­‰è½¯å®åŠ›è€ƒæ ¸ä¸­ï¼Œè¿™éœ€è¦**ç»ˆå±€æ€ç»´ä¸‹çš„é€»è¾‘é‡æ„**ã€‚\n\nğŸ’¡ **è¡ŒåŠ¨æŒ‡å—ï¼š** è¯·å‘Šè¯‰æˆ‘æ‚¨çš„EJUç›®æ ‡åˆ†æ•°æ®µå’Œæœ€æ²¡ä¿¡å¿ƒçš„ç§‘ç›®ï¼Œæˆ‘ä»¬ä»ç­–ç•¥ä¸Šè¿›è¡Œé‡æ„ï¼"
        },
        // 7. æ—¥æœ¬ç”Ÿæ´»åˆè§„é—®é¢˜ï¼ˆè¾ƒä½ä¼˜å…ˆçº§ï¼Œé¿å…è¢«ä¸¥è‚ƒå­¦æœ¯é—®é¢˜è¦†ç›–ï¼‰
        {
            keywords: ['ç­¾è¯', 'é£è¿”', 'æ³•å¾‹', 'ä¿é™©', 'å¹´é‡‘'],
            priority: 5, 
            response: "ã€æ—¥æœ¬ç”Ÿæ´»ä¸åˆè§„æ€§ã€‘ğŸ‡¯ğŸ‡µ\n\n**å¥åº·ä¿é™©å’Œå›½æ°‘å¹´é‡‘**æ˜¯æ‚¨åœ¨æ—¥æœ¬åˆæ³•ç”Ÿæ´»å’Œå­¦ä¹ çš„**åŸºç¡€ä¿éšœ**ã€‚ä»»ä½•æ•…æ„é€ƒé¿ç¼´çº³æˆ–æ»¥ç”¨èµ„é‡‘çš„è¡Œä¸ºéƒ½å¯èƒ½å½±å“æ‚¨çš„**ç­¾è¯æ›´æ–°å®¡æŸ¥**ã€‚\n\n1. **ç§‹æ­¦å»ºè®®ï¼š** å»ºè®®æ‚¨å°†ç²¾åŠ›é‡æ–°èšç„¦äºæ‚¨çš„**ç•™å­¦ç›®æ ‡å’Œå­¦æœ¯è§„åˆ’**ä¸Šæ¥ï¼Œç¡®ä¿æ‰€æœ‰ç”Ÿæ´»å’Œå­¦ä¹ æ´»åŠ¨éƒ½åœ¨**åˆè§„é€æ˜**çš„æ¡†æ¶ä¸‹è¿›è¡Œã€‚\n2. **é£é™©è¯„ä¼°ï¼š** ç­¾è¯é—®é¢˜å±äºé«˜é£é™©é¢†åŸŸï¼Œè¯·ä¸¥è‚ƒå¯¹å¾…ã€‚\n\nğŸ’¡ **ä¸‹ä¸€æ­¥ï¼š** æ‚¨å¯ä»¥å‘Šè¯‰æˆ‘æ‚¨çš„ç•™å­¦ç›®æ ‡ï¼Œæˆ‘ä»¬ä¸“æ³¨äº**å­¦æœ¯ä¸Šçš„é€»è¾‘é‡æ„**ã€‚"
        }
    ];

    /**
     * å“åº”ç”Ÿæˆå™¨ (Dialogue Strategy Layer)
     */
    function generateAIResponse(rawText) {
        
        // ã€ç¬¬ä¸€æ­¥ï¼šå¹½é»˜/éä¸¥è‚ƒè¯†åˆ« - æ¢å¤äººæ€§åŒ–ã€‘
        if (checkNonSeriousIntent(rawText)) {
            // åŒ¹é…åˆ°å¹½é»˜/éä¸¥è‚ƒï¼Œç›´æ¥è¿”å›é¢„è®¾çš„å¹½é»˜å›å¤
            return `
ğŸ‘‰ å“ˆå“ˆï¼Œæ‚¨è¿™ä¸ªé—®é¢˜å¤ªæœ‰è¶£äº†ï¼Œç§‹æ­¦è€å¸ˆä¹Ÿè¢«æ‚¨çš„ *å¹½é»˜æ„Ÿé€—ç¬‘äº†ï¼ğŸ˜Š \nÂ 
ä¸è¿‡ï¼Œä»ä¸“ä¸šçš„è§’åº¦çœ‹ï¼Œè¯·åŠ¡å¿…ä¿æŒå¯¹æ—¥æœ¬æ³•å¾‹å’Œç”Ÿæ´»è§„èŒƒçš„å°Šé‡å’Œéµå®ˆã€‚ \nÂ 
*å¥åº·ä¿é™©å’Œå›½æ°‘å¹´é‡‘æ˜¯æ‚¨åœ¨æ—¥æœ¬åˆæ³•ç”Ÿæ´»å’Œå­¦ä¹ çš„**åŸºç¡€ä¿éšœ**ï¼Œå®ƒä»¬ä¸å¶åƒå‘¨è¾¹æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„èŒƒç•´ã€‚ \nÂ 
ä»»ä½•æ•…æ„é€ƒé¿ç¼´çº³æˆ–æ»¥ç”¨èµ„é‡‘çš„è¡Œä¸ºéƒ½å¯èƒ½å½±å“æ‚¨çš„ *ç­¾è¯æ›´æ–°å®¡æŸ¥ï¼Œè¿™æ˜¯é£é™©æé«˜çš„è¡Œä¸ºã€‚ \nÂ 
æˆ‘ä»¬å»ºè®®æ‚¨å°†ç²¾åŠ›é‡æ–°èšç„¦äºæ‚¨çš„ *ç•™å­¦ç›®æ ‡å’Œå­¦æœ¯è§„åˆ’ä¸Šæ¥ï¼Œç¡®ä¿æ‰€æœ‰ç”Ÿæ´»å’Œå­¦ä¹ æ´»åŠ¨éƒ½åœ¨ *åˆè§„é€æ˜çš„æ¡†æ¶ä¸‹è¿›è¡Œã€‚\nÂ 
ğŸ’¡ æœ¬ç³»ç»Ÿæä¾›å¿«é€Ÿã€ç»“æ„åŒ–çš„å’¨è¯¢æœåŠ¡ã€‚å¦‚æœæ‚¨çš„æé—®è¾ƒä¸ºå¤æ‚ã€æ¶‰åŠä¸ªäººè¯¦ç»†æƒ…å†µæˆ–éœ€è¦ *ç»ˆå±€æ€ç»´ä¸‹çš„é€»è¾‘é‡æ„ï¼Œå»ºè®®æ·»åŠ ç§‹æ­¦è€å¸ˆå¾®ä¿¡è¿›è¡Œ *ä¸€å¯¹ä¸€æ·±åº¦æ²Ÿé€šã€‚\nÂ 
ï½ï½ğŸŒ¸æ±å¤§ãƒç§‹æ›¸å ‚
            `.trim();
        }

        // ã€ç¬¬äºŒæ­¥ï¼šæ ¸å¿ƒçŸ¥è¯†åº“åŒ¹é…ã€‘
        const text = normalizeInput(rawText);
        
        let bestMatch = null;
        let maxScore = 0;

        knowledgeBase.forEach(item => {
            let matchCount = 0;
            item.keywords.forEach(keyword => {
                if (text.includes(keyword)) {
                    matchCount++;
                }
            });

            if (matchCount > 0) {
                const score = matchCount * item.priority;
                if (score > maxScore) {
                    maxScore = score;
                    bestMatch = item;
                }
            }
        });

        if (bestMatch && maxScore > 0) {
            // ä¸“ä¸šå›å¤ï¼Œç§»é™¤æƒ…ç»ªåŒ–è¡¨æƒ…
            return bestMatch.response.replace(/ğŸŒ¸|ğŸ˜Š|ğŸ¤”/g, ''); 
        }

        // ã€ç¬¬ä¸‰æ­¥ï¼šé»˜è®¤å“åº” - ç»ˆå±€æ€ç»´ä¸‹çš„å¼•å¯¼ï¼ˆé’ˆå¯¹é•¿æ–‡/å¤æ‚é—®é¢˜ï¼‰ã€‘
        return `
ãã®ã”è³ªå•ã¯ã€ç§‹æ­¦å…ˆç”Ÿçš„**ã€Œç»ˆå±€æ€ç»´ã€**éœ€è¦åˆ†æçš„ä¸»é¢˜ã€‚
\n
æ‚¨çš„æé—®è¾ƒä¸ºå¤æ‚ï¼Œæ¶‰åŠ**å¤šç»´åº¦é€»è¾‘æ‹†è§£**ï¼Œå¯èƒ½éœ€è¦æ–‡ç†èåˆçš„è§†è§’æ¥é‡æ–°æ„å»ºã€‚\n
\n
ğŸ’¡ **æœ€ä¸­è‚¯çš„è§£å†³æ–¹æ¡ˆï¼š** æ‚¨å¯ä»¥ç›´æ¥æ·»åŠ ç§‹æ­¦è€å¸ˆå¾®ä¿¡ï¼ˆID: qiuwu999ï¼‰ï¼Œè¿›è¡Œæ–‡ç†èåˆè§†è§’ä¸‹çš„**ä¸€å¯¹ä¸€æ·±åº¦è¯Šæ–­**ï¼Œæˆ‘ä»¬å°†ä¸“æ³¨äºå¯¹æ‚¨ä¸ªäººæƒ…å†µçš„**é€»è¾‘é‡æ„**ã€‚
        `;
    }
});
